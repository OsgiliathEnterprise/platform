<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/asciidoc/reference/virtualization/virtualmachines.adoc at 2024-03-03
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>osgiliath-platform &#x2013; </title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
    <script src="../../js/apache-maven-fluido-1.8.min.js"></script>
  </head>
  <body class="topBarEnabled">
    <header id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../reference/toc.html" title="Reference Documentation">Reference Documentation</a></li>
            <li><a href="../../contributor/toc.html" title="Developer guide">Developer guide</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../project-info.html" title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                  <li><a href="../../integration.html" title="Continuous Integration">Continuous Integration</a></li>
                  <li><a href="../../dependency-info.html" title="Dependency Information">Dependency Information</a></li>
                  <li><a href="../../distribution-management.html" title="Distribution Management">Distribution Management</a></li>
                  <li><a href="../../index.html" title="About">About</a></li>
                  <li><a href="../../issue-tracking.html" title="Issue Tracking">Issue Tracking</a></li>
                  <li><a href="../../license.html" title="Project License">Project License</a></li>
                  <li><a href="../../mail-lists.html" title="Mailing Lists">Mailing Lists</a></li>
                  <li><a href="../../plugin-management.html" title="Plugin Management">Plugin Management</a></li>
                  <li><a href="../../plugins.html" title="Project Plugins">Project Plugins</a></li>
                  <li><a href="../../team-list.html" title="Project Team">Project Team</a></li>
                  <li><a href="../../source-repository.html" title="Source Repository">Source Repository</a></li>
                  <li><a href="../../project-summary.html" title="Project Summary">Project Summary</a></li>
              </ul>
            </li>
            <li class="dropdown-submenu">
<a href="../../project-reports.html" title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                  <li><a href="../../dependency-updates-report.html" title="Dependency Updates Report">Dependency Updates Report</a></li>
                  <li><a href="../../plugin-updates-report.html" title="Plugin Updates Report">Plugin Updates Report</a></li>
                  <li><a href="../../property-updates-report.html" title="Property Updates Report">Property Updates Report</a></li>
              </ul>
            </li>
        </ul>
      </li>
            </ul>
        </div>
      </div>
    </header>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="https://github.com/OsgiliathEnterprise/platform" id="bannerLeft"><h2>Github repository</h2>
</a></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2024-03-03<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.0.2-SNAPSHOT</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Documentation</li>
    <li><a href="../../reference/toc.html" title="Reference Documentation"><span class="none"></span>Reference Documentation</a></li>
    <li><a href="../../contributor/toc.html" title="Developer guide"><span class="none"></span>Developer guide</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<h1>Virtual machines</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>As stated in the <a href="../packer/introduction.html#main-title">introduction</a>, Virtual machines are full machines, started from within your host&#8217;s OS or hypervisor<br/>
Within the platform, we are relying on multiple Virtualization technologies depending on the use case.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="containers.html#main-title">Containers</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="access_to_the_vms">Access to the VMs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There&#8217;s a race condition between firewalld and libvirt concerning port forwarding.
To be sure that packets are well forwarded, executes: <code>sudo sh /etc/libvirt/hooks/qemu</code> at each reboot of firewalld (includin machine reboot)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wipe_vms">Wipe VMS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sometimes script can mess and you want to restart from a blank page.
As VMs are not that easy to manage, you should execute some commands in order to go back to the initial mode (for example, when you modified the name of one VM)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the machines
You should first delete the machine:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo virsh list
sudo virsh destroy &lt;the machines&gt;
sudo virsh undefine &lt;the machines&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the dhcp host entries</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo virsh net-dumpxml default
sudo virsh net-update default delete ip-dhcp-host &quot;&lt;host mac='&lt;the macadress&gt;' name='&lt;the host' ip='&lt;the ip&gt;'/&gt;&quot; --live</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use <code>virsh net-edit default</code>, <code>virsh net-destroy default</code>, <code>virsh net-start default</code> for bulk edit.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the firewall redirection rules</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo firewall-cmd --list-all --zone=public
sudo firewall-cmd --zone=public --remove-rich-rule='rule family=&quot;ipv4&quot; forward-port port=&quot;&lt;the port&gt;&quot; protocol=&quot;&lt;the protocol&gt;&quot; to-port=&quot;&lt;the destination port&gt;&quot; to-addr=&quot;&lt;the vm adress&gt;&quot;'
sudo firewall-cmd --runtime-to-permanent</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete ssh hook
The default vagrant boxes ssh keys are downloaded on the host in order to access the machines when they are downloaded, then these keys are deleted and VMs are considered 'configured'.
If you want to reset VMs, you&#8217;ll also have to delete the persistent facts</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo rm /etc/ansible/facts.d/ansible_virtualization_guest.fact</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the images
The box images could have been updated, please also remove the content of the <code>sudo rm -rf /var/lib/libvirt/images</code> folder</p>
</li>
<li>
<p>additional host entries</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally, there could be some additional entries in <code>/etc/host</code> that won&#8217;t be useful anymore</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="make_the_network_configuration_permanent">Make the network configuration permanent</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s not very clear if network dhcp leases configuration are permanent or not after reboots</p>
</div>
<div class="paragraph">
<p>You can verify after reboot if you already have your <code>&lt;host</code> entries while typing the command `sudo virsh net-dumpxml default`on your host.</p>
</div>
<div class="paragraph">
<p>In order to be sure that it&#8217;s the actual behavior, you&#8217;ve to first retrieve the guests mac adress:
<code>sudo virsh domiflist &lt;guest hostname&gt;</code></p>
</div>
<div class="paragraph">
<p>Then update the virsh net configuration:
<code>sudo virsh net-update default add ip-dhcp-host '&lt;host mac="&lt;mac address&gt;" ip="&lt;target ip&gt;"/&gt;' --live --config</code></p>
</div>
</div>
</div>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      2020&#x2013;2024<a href="not at the moment">Osgiliath (Charlie Mordant)</a>.
.</p>
        </div>
      </div>
    </footer>
  </body>
</html>